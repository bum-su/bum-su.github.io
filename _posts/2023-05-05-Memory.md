---
layout: post
title: c++ 메모리 구조
date: 2023-05-05 18:34:00 +0900
categories: C++ Variable
tags: Memory MemoryLeak
---

# 서론
지역 변수는 **스택 영역**에 <br/>
정적, 전역 변수는 **DATA 영역**에 <br/>
동적 변수는 **힙 영역**에 메모리가 할당된다고 한다. <br/>
마지막으로 코드 영역은 실행할 프로그램의 코드가 할당 된다.<br/><br/>

그럼
**araboza**

## 메모리 구조
----------------
메모리는 대개 다음 영역으로 구분된다.
- 코드 영역 : 실행 가능한 코드가 저장되는 영역
- 데이터 영역 : 전역 변수와 정적 변수가 저장되는 영역 (BSS, DATA)
- 힙 영역 : 동적으로 할당된 메모리가 저장되는 영역
- 스택 영역 : 함수 호출과 지역 변수에 대한 메모리가 저장되는 영역

![memory](https://user-images.githubusercontent.com/69189889/236433871-b81dd30b-3810-403e-86c3-36acd849a080.png)
https://ko.wikipedia.org/wiki/%EB%8F%99%EC%A0%81_%EB%A9%94%EB%AA%A8%EB%A6%AC_%ED%95%A0%EB%8B%B9

## 스택 영역
----------
반환 주소(해당 함수를 호출하기 직전의 위치)와 지역 변수 등이 저장되는 영역이 바로 스택입니다. 스택은 함수 호출이 이루어질 때마다 새로운 스택 프레임을 생성하고, 함수가 종료되면 해당 스택 프레임을 자동으로 해제하는 특징이 있습니다.

메모리 할당 및 해제가 자동으로 처리되기 때문에, 사용자가 별도의 메모리 관리를 할 필요가 없습니다. 하지만 스택의 크기는 컴파일 시점에 결정되어 실행 중에는 변경할 수 없기 때문에, 스택 영역의 메모리가 고갈되면 스택 오버플로우가 발생할 수 있습니다.

데이터 관리 측면에서 스택은 LIFO(Last In First Out) 방식을 따르고 있어, 가장 마지막에 들어온 데이터가 가장 먼저 나가게 됩니다. 

```cpp 
#include <stdio.h>

void functionB() {
    int localVarB = 10; // 지역 변수 할당 (스택 영역)
    printf("Local variable in function B: %d\n", localVarB);
} // 함수 종료 시 localVarB 메모리가 해제된다

void functionA() {
    int localVarA = 5; // 지역 변수 할당 (스택 영역)
    printf("Local variable in function A: %d\n", localVarA);
    functionB(); // functionB 호출
} // 함수 종료 시 localVarA 메모리가 해제된다

int main() {
    functionA(); // functionA 호출
    return 0;
}

```
**지역 변수와 매개 변수들은 일시적으로 사용되는 특성이 있다. 그래서 함수가 종료되면 메모리를 효율적으로 관리하기 위해 스택에 할당된다.**

## 힙 영역
---------------
힙 영역은 동적 메모리 할당의 주요 장소로, 프로그램이 실행되는 동안 필요한 만큼 메모리를 할당받을 수 있는 공간입니다. 

이는 프로그램 실행 중에도 메모리 크기를 동적으로 변경할 수 있음을 의미합니다.

하지만 이 힙 영역의 메모리는 사용자가 직접 제어해야 합니다. 즉, 메모리의 할당과 해제를 프로그래머가 직접 관리해야 하며, 이로 인해 메모리 누수와 같은 문제가 발생할 수 있습니다. 

또한 메모리를 재사용하면서 메모리 내에 작은 조각들이 생겨나면서 메모리 사용 효율이 떨어질 수 있습니다. 이를 프래그멘테이션이라 합니다. (메모리 단편화)

그럼에도 불구하고, 힙 영역의 메모리는 그 수명이 길다는 장점이 있습니다. 프로그래머가 명시적으로 해제하지 않는 한, 프로그램이 종료될 때까지 그 메모리는 계속 유지됩니다.
  
```cpp
#include <iostream>

int main() {
    int *dynamicArray = nullptr;
    int size = 10;

    dynamicArray = new int[size]; // 동적 메모리 할당

    if (dynamicArray == nullptr) {
        std::cout << "Memory allocation failed." << std::endl;
        return 1;
    }

    for (int i = 0; i < size; i++) {
        dynamicArray[i] = i + 1;
    }

    for (int i = 0; i < size; i++) {
        std::cout << "dynamicArray[" << i << "] = " << dynamicArray[i] << std::endl;
    }

    delete[] dynamicArray; // 메모리 해제

    return 0;
}
```
**아래는 동적 변수를 힙에 할당하는 이유다.**
1. 동적 변수의 크기가 동적으로 변경될 수 있어, 더 많은 메모리를 할당할 수 있는 점
2. 프로그램이 종료될 때까지 할당된 메모리가 유지. 필요한 경우 메모리 해제를 수동으로 진행할 수 있는 점 (유연성)
3. 힙 메모리의 크기는 스택보다 매우 크기 때문에, 큰 데이터 구조를 저장이 가능 한 점

## 데이터 영역
-------------
**데이터 영역(data segment)은 프로그램의 전역, 정적 변수및 상수 값을 저장하는 메모리 영역**

데이터 영역은 프로그램의 중요한 구성요소로, 전역 변수와 정적 변수를 저장하는 공간입니다. 이 공간에 저장된 변수들은 프로그램이 시작되는 순간부터 종료될 때까지 계속 유지되며, 이를 통해 프로그램 전체에서 접근 및 사용할 수 있습니다.

데이터 영역의 크기는 컴파일 시점에 결정되므로, 실행 도중에는 이를 변경할 수 없습니다. 이는 메모리 관리 측면에서 안정성을 제공하지만, 동적으로 크기를 조절할 수 없다는 제한점도 있습니다.

또한, 데이터 영역은 초기화된 데이터 영역과 초기화되지 않은 데이터 영역으로 나뉩니다. 초기화된 변수는 DATA에, 반면 초기화되지 않은 변수는 BSS에 저장됩니다.

  
## 코드 영역
-----------
**실행할 프로그램의 코드가 저장되는 영역**

코드 영역은 프로그램의 실행 가능한 기계어 코드를 저장하는 공간으로, 프로그램이 시작되는 순간부터 종료될 때까지 유지되는 영역입니다. 

코드 영역은 일반적으로 읽기 전용으로 설정되어 있어, 실행 중에 변경되지 않습니다. 이렇게 함으로써 프로그램의 안정성과 보안성이 향상됩니다.

또한 코드 영역의 크기는 컴파일 시점에 결정되어 실행 도중에 변경할 수 없습니다. 이러한 특성은 메모리 관리의 안정성을 제공하지만, 실행 중에 크기를 동적으로 변경할 수 없다는 제한점이 있습니다.

코드 영역은 프로그램의 핵심이 되는 실행 코드를 저장하고 보호하는 역할을 수행합니다.
  
# 정리
-------------
1. 스택 영역
   - 스택 영역은 함수 호출 관련 정보를 저장하는 메모리 공간이다.
   - 함수가 호출될 때마다 새로운 스택 프레임이 생성되고, 함수 종료 시 해당 스택 프레임이 해제된다.
   - 메모리 할당 및 해제가 자동으로 이루어지며, 크기는 컴파일 시점에 결정되고 변경할 수 없다.
   - 스택 오버플로우가 발생할 수 있으며, LIFO 방식으로 데이터를 관리한다.
2. 힙 영역
   - 힙 영역은 동적으로 메모리를 할당하는 데 사용되며, 사용자가 직접 할당 및 해제해야 한다.
   - 메모리 누수가 발생할 수 있으며, 메모리 크기를 실행 중에 동적으로 변경할 수 있다.
   - 메모리 단편화가 발생할 가능성이 있으며, 필요에 따라 메모리를 할당하고 해제할 수 있다.
3. 데이터 영역
   - 데이터 영역은 전역 변수와 정적 변수를 저장하는 공간이다.
   - 프로그램 실행 중 데이터 영역의 변수들은 유지되며, 크기는 컴파일 시점에 결정되고 변경할 수 없다.
   - 초기화된 변수는 DATA 영역에, 초기화되지 않은 변수는 BSS 영역에 저장된다.
4. 코드 영역
   - 실행 가능한 기계어 코드를 저장하는 메모리 공간이다
   - 실행 중에는 데이터가 변경되지 않고, 일반적으로 읽기 전용으로 설정된다.
   - 프로그램 실행 중 코드 영역의 내용은 계속 유지된다.
   - 코드 영역의 크기는 컴파일 시점에 결정되며, 실행 중에는 변경할 수 없음